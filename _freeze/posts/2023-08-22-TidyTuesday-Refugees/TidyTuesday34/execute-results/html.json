{
  "hash": "0ff58fc8001868302a8c4c19a5330f32",
  "result": {
    "markdown": "---\ntitle: \"TidyTuesday-Refugees\"\n---\n\n\nI'm still behind on TidyTuesday, so here is [TidyTuesday #34](https://github.com/rfordatascience/tidytuesday/blob/master/data/2023/2023-08-22/readme.md), which deals with [refugee data](https://www.unhcr.org/refugee-statistics/insights/explainers/refugees-r-package.html).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse) # who doesn't want to be tidy\nlibrary(networkD3) # for sankey plots\nlibrary(ggsankey) # another sankey package \n\nlibrary(htmlwidgets)\nlibrary(htmltools)\n```\n:::\n\n\nLoading data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntuesdata <- tidytuesdayR::tt_load(2023, week = 34)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n--- Compiling #TidyTuesday Information for 2023-08-22 ----\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n--- There is 1 file available ---\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n--- Starting Download ---\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tDownloading file 1 of 1: `population.csv`\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n--- Download complete ---\n```\n:::\n\n```{.r .cell-code}\npopulation <- tuesdata$population\n```\n:::\n\n\n## Exploratory Data Analysis\n\nThis dataset tracks the number of refugees by year. It tracks the how many request entry at each country and breaks this information down by country of origin.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(population)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 16\n   year coo_name    coo   coo_iso coa_name coa   coa_iso refugees asylum_seekers\n  <dbl> <chr>       <chr> <chr>   <chr>    <chr> <chr>      <dbl>          <dbl>\n1  2010 Afghanistan AFG   AFG     Afghani… AFG   AFG            0              0\n2  2010 Iran (Isla… IRN   IRN     Afghani… AFG   AFG           30             21\n3  2010 Iraq        IRQ   IRQ     Afghani… AFG   AFG            6              0\n4  2010 Pakistan    PAK   PAK     Afghani… AFG   AFG         6398              9\n5  2010 Egypt       ARE   EGY     Albania  ALB   ALB            5              0\n6  2010 China       CHI   CHN     Albania  ALB   ALB            6              0\n# ℹ 7 more variables: returned_refugees <dbl>, idps <dbl>, returned_idps <dbl>,\n#   stateless <dbl>, ooc <dbl>, oip <dbl>, hst <dbl>\n```\n:::\n:::\n\n\nWhat years have the most data?\n\n\n::: {.cell}\n\n```{.r .cell-code}\npopulation %>%\n  group_by(year) %>%\n  count() %>%\n  ggplot(aes(year, n)) +\n  geom_col()\n```\n\n::: {.cell-output-display}\n![](TidyTuesday34_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\nI expected so see spikes corresponding to specific events, but instead it looks like the data is gradually increasing. This might just be due to better record keeping/ data collection over the years.\n\nI'm going to look at last year's data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npop_2022 <- population %>%\n  filter(year == 2022)\n```\n:::\n\n\nNow I'm going to look at where most of the refugees are coming from. Note that this isn't the number of refugees- it is the number of countries where they requested entry. So Syrian refugees went to 121 different countries requesting assylum or refugee status.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npop_2022 %>% group_by(coo_name) %>% count(sort = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 205 × 2\n# Groups:   coo_name [205]\n   coo_name                   n\n   <chr>                  <int>\n 1 Syrian Arab Rep.         121\n 2 Afghanistan              103\n 3 Somalia                  103\n 4 Dem. Rep. of the Congo   100\n 5 Iraq                     100\n 6 Sudan                    100\n 7 Yemen                     95\n 8 Eritrea                   93\n 9 Pakistan                  93\n10 Nigeria                   92\n# ℹ 195 more rows\n```\n:::\n:::\n\n\nThere is a technical and legal difference between refugees and asylum seekers, but I'm going to sum them up. I also will be using refugees and asylum seekers interchangeably here.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npop_2022 <- pop_2022 %>%\n  mutate(total = refugees + asylum_seekers) %>%\n  select(coo_name, coa_name, total)\n```\n:::\n\n\nI've been interested in learning how to make Sankey diagrams in R. This data does lend itself to a Sankey diagram, which is usually used to track flow.\n\nI do want to highlight that the UN Refugee Agency has a separate dataset that tracks [flow](https://www.unhcr.org/refugee-statistics/insights/explainers/forcibly-displaced-flow-data.html). The dataset we are working with is the net number of refugees. As the UNHCR webpage says:\n\n> Often the net increase or decrease in stock figures between years has been used in lieu of accurate flow figures. But these may underrepresent the true magnitude of population movements if, for example, refugee arrivals and departures balance each other out.\n\nStill, for TidyTuesday, the net population is fine.\n\nI'm going to pull out the top 3 sources of refugees. I'm grouping by the country of origin (coo_name) and then summing the refugees going to all countries. I then take the top 3 using dpylr's slice_max(). Note that this function replaces top_n().\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntop_3_source <- pop_2022 %>%\n  group_by(coo_name) %>%\n  summarize(num_by_coo = sum(total)) %>%\n  slice_max(order_by = num_by_coo, n = 3)\n\ntop_3_source_names <- top_3_source$coo_name\n\ntop_3_source_names\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"Syrian Arab Rep.\" \"Afghanistan\"      \"Ukraine\"         \n```\n:::\n:::\n\n\nNow I'm going to do a related analysis and see where the top destinations are.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntop_3_dest <- pop_2022 %>%\n  group_by(coa_name) %>%\n  summarize(num_by_coa = sum(total)) %>% slice_max(order_by = num_by_coa, n = 3)\n\ntop_3_dest_names <- (top_3_dest$coa_name)\ntop_3_dest_names\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"Türkiye\"                \"Iran (Islamic Rep. of)\" \"Germany\"               \n```\n:::\n:::\n\n\nNow making a category \"other\" for both source and destination countries that aren't in the top 3. This uses the forcats function fct_other.\n\nFirst country of arrival:\n\n\n::: {.cell}\n\n```{.r .cell-code}\npop_2022$coa_name = factor(pop_2022$coa_name)\n\npop_2022$coa_name <- pop_2022$coa_name %>%\n  fct_other(keep = top_3_dest_names, other_level = \"other\")\n```\n:::\n\n\nThen country of origin:\n\n\n::: {.cell}\n\n```{.r .cell-code}\npop_2022$coo_name = factor(pop_2022$coo_name)\n\npop_2022$coo_name <- pop_2022$coo_name %>%\n  fct_other(keep = top_3_source_names, other_level = \"other\")\n```\n:::\n\n\nFor now, I'm going to remove the \"other\" category of country of origin.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npop_2022_no_other <- pop_2022 %>%\n  filter((coo_name != \"other\"))\n```\n:::\n\n\nThere are 3 popular ways to make Sankey diagrams in R: ggsankey, networkD3, and plotly. There is a nice tutorial on these methods [here](https://www.marsja.se/create-a-sankey-plot-in-r-ggplot2-plotly/).\n\nI'm going to focus on ggsankey and networkD3.\n\n# ggsankey method for Sankey Plots in R\n\n[This package](https://github.com/davidsjoberg/ggsankey) is used in combination with ggplot to make nice static Sankey plots.\n\nThe package documentation does a great job explaining the [parts of the Sankey chart](https://github.com/davidsjoberg/ggsankey). It does not do a great job explain what format the data should be in. I spent most of my time last Tuesday trying to figure this out.\n\nThe package includes a function make_long(), which is used to prepare the data for plotting. It labels the columns appropriately and creates the needed null/ NA entries. These entries are used to signify the end of the flow.\n\nThe UN refugee data is already long, so I spent a fair bit of time trying to figure out how to either label it myself or make it wide so I could use make_long().\n\nIt turns out that ggsankey can only be used on disagreggated data, and not aggregated data such as I have here. I never found that explicitly stated in the documentation (could be I missed that), but only discovered it as I was trying to wrangle my data into the corrrect format and comparing it to the mtcars data in the example.\n\nWhat do I mean by aggregated vs. disaggregated?\n\nLet's look at the mtcars dataframe:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmtcars2 <- mtcars %>%\n  slice_sample(n = 10) %>%\n  select(cyl, vs)\n\nmtcars2\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                    cyl vs\nMerc 450SE            8  0\nHonda Civic           4  1\nMerc 280C             6  1\nMaserati Bora         8  0\nLincoln Continental   8  0\nMazda RX4 Wag         6  0\nValiant               6  1\nToyota Corolla        4  1\nDuster 360            8  0\nMerc 450SL            8  0\n```\n:::\n:::\n\n\nThis is disagreggated. It reports the properties of each car. The equivalent in our dataset would be if the database listed every refugee by name and specified where they were from and where they were going.\n\nWhat the population dataset has instead is the agregated data. This is the mtcars equivalent:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmtcars2 %>% group_by(cyl, vs) %>% count()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 × 3\n# Groups:   cyl, vs [4]\n    cyl    vs     n\n  <dbl> <dbl> <int>\n1     4     1     2\n2     6     0     1\n3     6     1     2\n4     8     0     5\n```\n:::\n:::\n\n\nSo we know we have two cars with cyl = 4 and vs = 1, but we don't know that they are specifically the Merc 240D and the Fiat 128.\n\nIf all you have is the aggregated data, you can't disagregate it. The names of the cars are not contained in that dataframe. In this case, if you absolutely had to make a Sankey diagram using ggsankey, you could write some code to make a dummy id to represent the missing dimension. That is, you could split with cyl = 4 and vs = 1 into\n\ncyl = 4 and vs = 1 and id = 1\n\ncyl = 4 and vs = 1 and id = 2\n\nand so on for each group.\n\nThen you'd have to dpylr::pivot_wider() and then ggsankey::make_longer(). I wouldn't recommend this, but it is useful sometimes to think of how you'd approach a problem, even if there are easier solutions.\n\n# networkD3 method for Sankey Plots in R\n\nI love the R Graph Gallery when I'm looking for inspiration for TidyTuesday. [R Graph Gallery actually recommends the networkD3 package for Sankey plots](https://r-graph-gallery.com/sankey-diagram.html), but it is an htmlwidget. I've been doing a lot of interactive stuff recently, and I originally wanted to get back to some good old ggplot. But the [networkD3 package](https://CRAN.R-project.org/package=networkD3) does create lovely Sankey plots.\n\nThe networkD3 method seems a bit more confusing, because you need to transorm and label the data yourself. Like ggsankey, you need information about the nodes and how they are connected with each other. One other note- this is based on a JavaScript package which started indexing at 0. So a few \"-1\" to convert the index from R (which starts at 1).\n\nThere is a really nice blog post on Sankey diagrams in networkD3 [on Data to Viz](https://www.data-to-viz.com/graph/sankey.html). The code is hidden, so you need to toggle it on with the code button if you want to see it.\n\nThe function call is (from the manual found at CRAN):\n\n`sankeyNetwork(Links, Nodes, Source, Target, Value, NodeID, NodeGroup = NodeID, LinkGroup = NULL, units = \"\", colourScale = JS(\"d3.scaleOrdinal(d3.schemeCategory20);\"), fontSize = 7, fontFamily = NULL, nodeWidth = 15, nodePadding = 10, margin = NULL, height = NULL, width = NULL, iterations = 32, sinksRight = TRUE)`\n\nI need `Links, Nodes, Source, Target, Value, NodeID.`\n\nNodes is the list of countries (both orgin and arrival). It needs to be a unique list of the countries stored as a dataframe.\n\nI converted the countries to factors earlier, but that isn't a problem.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnodes <- data.frame(name =\n                      c(pop_2022_no_other$coo_name, pop_2022_no_other$coa_name) %>%\n                      unique()\n                    )\n```\n:::\n\n\nNext we need the IDs for source and target, zero indexed. The ID is generated by position in the node dataframe I just created. The match() function is a base R function that returns a vector of the positions of the first argument (pop_2022_no_other\\$coo_name) as found in the second argument (nodes\\$name). Note that it returns a vector of all matches. I know that nodes is a unique list, so it is only going to return a single index. This may not be true for other use cases. Again, subtracting 1 for the difference in indexing.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npop_2022_no_other$IDsource = match(pop_2022_no_other$coo_name, nodes$name) -\n  1\npop_2022_no_other$IDtarget = match(pop_2022_no_other$coa_name,  nodes$name) -\n  1\n```\n:::\n\n\nNext, create the color scales. Details about the options for the colors scales are found in the [D3 API documentation](https://github.com/d3/d3/blob/main/API.md#ordinal-scales).\n\nI am going to change the colors a bit. The other category will be gray. The colors are assigned matches using the order in the nodes df. Note that this does NOT match the order in the diagram. Most Sankey plotting programs reorder the nodes to minimize crossing and to create a cleaner diagram.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nColourScal = 'd3.scaleOrdinal([`#946943`,  `#b63e36`,`#F5B041`,  `#909497`,\n`#383867`, `#584c77`, `#33431e`, `#a36629`, `#92462f`])'\n```\n:::\n\n\nThe colors are specified in hex code here. You can find color pickers that give you the codes on the web, such as [this one](https://htmlcolorcodes.com/).\n\nNow I can make the diagram. I'm also specifying height and width so [I can add a title and a caption using htmlwidgets](https://stackoverflow.com/questions/50132459/how-to-add-title-to-a-networkd3-visualisation-when-saving-as-a-web-page). If you don't specify height and width the figure might be truncated when the titles are applied. (This method might work for leaflet maps also. The leaflet package also lacks a method for titles.)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Make the Network\nsankey <- sankeyNetwork(Links = pop_2022_no_other, Nodes = nodes,\n              Source = \"IDsource\", Target = \"IDtarget\",\n              Value = \"total\", NodeID = \"name\", \n              sinksRight = FALSE, colourScale = ColourScal, nodeWidth = 40, fontSize=13, nodePadding = 20, width = 600, height = 400)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLinks is a tbl_df. Converting to a plain data frame.\n```\n:::\n\n```{.r .cell-code}\nsankey <- htmlwidgets::prependContent(sankey, htmltools::tags$h2(\"Refugee Flow in 2022\"))\nsankey <- htmlwidgets::appendContent(sankey, htmltools::tags$p(\"from UNHCR’s refugees R package\"))\n\nsankey\n```\n\n::: {.cell-output-display}\n```{=html}\n<h2>Refugee Flow in 2022</h2>\n<div id=\"htmlwidget-c3cb6cd246ec357cdbb5\" style=\"width:100%;height:433px;\" class=\"sankeyNetwork html-widget \"></div>\n<p>from UNHCR’s refugees R package</p>\n<script type=\"application/json\" data-for=\"htmlwidget-c3cb6cd246ec357cdbb5\">{\"x\":{\"links\":{\"source\":[0,0,1,2,1,1,0,1,2,0,1,2,0,1,2,0,1,2,0,1,2,0,1,2,1,0,1,2,1,0,1,0,1,2,1,2,0,1,2,0,1,2,0,1,2,0,1,2,1,0,1,2,0,1,2,1,1,1,0,1,2,1,2,0,1,0,1,2,0,1,2,0,1,2,1,0,1,2,0,1,2,0,1,2,1,0,0,1,2,0,1,2,0,1,2,0,1,2,0,1,2,0,1,2,0,1,2,2,1,0,0,0,1,2,0,1,2,0,1,2,1,0,1,2,0,1,0,1,2,0,0,1,2,2,0,1,2,0,1,2,0,1,2,0,1,2,0,1,0,1,2,0,1,2,0,1,1,0,1,0,1,2,1,2,0,0,1,2,0,1,2,0,1,2,0,1,1,1,2,1,0,1,2,0,1,2,1,0,1,0,0,1,1,0,1,2,0,1,2,0,2,0,1,2,1,0,1,2,0,1,2,0,0,1,2,1,0,1,0,1,2,0,1,2,0,1,2,0,1,2,0,0,1,2,0,1,2,1,0,1,2,0,1,0,1,2,1,1,0,1,2,1,0,1,2,0,1,0,1,2,0,1,2,0,1,2,0,1,2,0,1,1,0,1,0,0,1,1,0,1,2,0,1,2,0,1,0,1,0,1,2,0,1,2,0,1,2,0,0,1,1,0,1],\"target\":[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,5,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,6,6,6,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],\"value\":[0,14,23,2547,7803,5,381,145658,5,22,560,180,9,4912,528,11290,617,2029,52701,91167,90111,1176,35,4847,5,15938,20303,62660,52,5,5,152,66,19916,22,5,1042,7809,108,10,32,147,3569,29421,149231,2016,1012,75294,77,67,44,18,246,144,99,15,18,30,9,18,29,40,53,12,35,1714,20406,12566,229,347,433638,2103,19459,33706,10,8,5,14,147,158,84,33,107,40816,668,13,4265,2748,45506,74636,41331,70572,24321,20054,183399,83,468,26498,215677,576793,1004382,15,321,5,38246,45347,21931,5,14,5,11,405,594,19416,1457,819,29637,236,265,2335,157,15039,145,58,6991,44,2070,2607,70816,3413249,649,257439,5,414,20285,4489,151750,16,660892,10,570,309,2238,520,18,550,58,10,513,72,24,140,1320,39,17,253,80,5,14462,44,814715,16,34,402,87,274,493,65175,771,3852,4525,237,330,37810,16,5,578,6,386,5,32,233,102104,544,80,180,476,3392,2808,5,30,5516,6,10,2349,1819,0,0,32351,52,5,9403,57118,103647,15,5,1249,5,3498,17253,33253,5,74,60,22,14,1781386,73,11,5,21,15,96,9,5,62,36,10,202,14,18,1137,308,958519,880,933,44989,30,525,2616,100128,18,43,1589,252,1275925,5,3946,33,47,1108,1232,3903,16831,162672,0,93478,391,60,94858,88,340,7764,28249,112432,47846,20600,20794,60271,1239,0,36,146,214,9714,9,40,93,5,2497,29,139394,3535898,4957,34,6951,33,33,1060,533,0,6,72,18,21764,11944,15432,13026,10,33,2939,6,32]},\"nodes\":{\"name\":[\"Afghanistan\",\"Syrian Arab Rep.\",\"Ukraine\",\"other\",\"Germany\",\"Iran (Islamic Rep. of)\",\"Türkiye\"],\"group\":[\"Afghanistan\",\"Syrian Arab Rep.\",\"Ukraine\",\"other\",\"Germany\",\"Iran (Islamic Rep. of)\",\"Türkiye\"]},\"options\":{\"NodeID\":\"name\",\"NodeGroup\":\"name\",\"LinkGroup\":null,\"colourScale\":\"d3.scaleOrdinal([`#946943`,  `#b63e36`,`#F5B041`,  `#909497`,\\n`#383867`, `#584c77`, `#33431e`, `#a36629`, `#92462f`])\",\"fontSize\":13,\"fontFamily\":null,\"nodeWidth\":40,\"nodePadding\":20,\"units\":\"\",\"margin\":{\"top\":null,\"right\":null,\"bottom\":null,\"left\":null},\"iterations\":32,\"sinksRight\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\nSo this is pretty clear. Because the other category is disaggreated, we get individual lines for each country of arrival (but we don't know what countries they are.) If you mouse over the traces, you can see how many refugees are involved in each path. For example, if you mouse over the large gray band on the Afghanstan to other, you see 1.8 million refugees have gone to a single color. Some of the other lines represent only a handful of refugees. I could also aggregate the other data, which would create a single band from each source to other.\n\nSaving the interactive figures to a thumbnail is always tricky. There are a variety of methods suggested- using webshoot seems to be the most popular, but I haven't had it work. (First you save the diagram as a html, and then webshot converts that to a static image). While the html saves fine, the webshotted png is the title and the caption with a vast white block of no figure in between. The only consistent way I've found is to export from RStudio's viewer. You do have to fiddle with the height and width of your object otherwise the exported file will either be truncated or have non-functional scroll bars in the image.\n",
    "supporting": [
      "TidyTuesday34_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/htmlwidgets-1.6.2/htmlwidgets.js\"></script>\r\n<script src=\"../../site_libs/d3-4.5.0/d3.min.js\"></script>\r\n<script src=\"../../site_libs/sankey-1/sankey.js\"></script>\r\n<script src=\"../../site_libs/sankeyNetwork-binding-0.4/sankeyNetwork.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}